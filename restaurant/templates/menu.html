{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Th·ª±c ƒê∆°n - B√≤ Nh√∫ng Gi·∫•m Ng√†y X∆∞a{% endblock %}

{% block content %}
<style>
    .page-header {
        text-align: center;
        margin-bottom: 3rem;
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }
    
    .category-filter {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 3rem;
    }
    
    .category-btn {
        padding: 10px 25px;
        border: 2px solid var(--primary-color);
        background: var(--card-bg);
        color: var(--primary-color);
        border-radius: 25px;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        font-weight: 600;
    }
    
    .category-btn:hover,
    .category-btn.active {
        background: var(--nav-bg);
        color: white;
        border-color: var(--primary-color);
    }
    
    .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 3rem;
    }
    
    .menu-item {
        background: var(--card-bg);
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px var(--shadow);
        transition: transform 0.3s, box-shadow 0.3s;
        display: flex;
        flex-direction: column;
        cursor: pointer;
        border: 2px solid transparent;
    }
    
    .menu-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px var(--shadow);
        border-color: var(--primary-color);
    }
    
    .menu-item.unavailable {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .menu-item.unavailable:hover {
        transform: none;
        border-color: transparent;
    }
    
    .menu-item img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
    
    .menu-item-content {
        padding: 1.5rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    
    .menu-item h3 {
        color: var(--text-color);
        margin-bottom: 0.5rem;
        font-size: 1.3rem;
    }
    
    .menu-item .category-tag {
        display: inline-block;
        padding: 4px 12px;
        background: var(--border-color);
        color: var(--text-color);
        border-radius: 15px;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
        align-self: flex-start;
    }
    
    .menu-item .description {
        color: var(--text-color);
        opacity: 0.8;
        margin-bottom: 1rem;
        flex-grow: 1;
        font-size: 0.95rem;
    }
    
    .menu-item .price {
        font-size: 1.8rem;
        color: var(--primary-color);
        font-weight: bold;
        margin-bottom: 1rem;
    }
    
    .menu-item .add-btn {
        padding: 12px 20px;
        background: var(--nav-bg);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .menu-item .add-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow);
    }
    
    .menu-item .add-btn:active {
        transform: translateY(0);
    }
    
    .menu-item .add-btn.added {
        background: #28a745;
    }
    
    .menu-item .availability {
        padding: 8px 15px;
        border-radius: 5px;
        text-align: center;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    
    .menu-item .available {
        background: #d4edda;
        color: #155724;
    }
    
    .menu-item .unavailable-badge {
        background: #f8d7da;
        color: #721c24;
    }
    
    .no-items {
        text-align: center;
        padding: 3rem;
        color: var(--text-color);
        opacity: 0.8;
    }
    
    /* Cart Summary */
    .cart-summary {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--nav-bg);
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        min-width: 280px;
        z-index: 1000;
        display: none;
    }
    
    .cart-summary.show {
        display: block;
        animation: slideUp 0.3s ease;
    }
    
    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .cart-summary h3 {
        margin-bottom: 1rem;
        font-size: 1.2rem;
    }
    
    .cart-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    
    .cart-total {
        font-size: 1.3rem;
        font-weight: bold;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid rgba(255,255,255,0.3);
        display: flex;
        justify-content: space-between;
    }
    
    .cart-actions {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .cart-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
    }
    
    .checkout-btn {
        background: white;
        color: var(--primary-color);
    }
    
    .clear-btn {
        background: transparent;
        color: white;
        border: 2px solid white;
    }
    
    .cart-btn:hover {
        transform: scale(1.05);
    }
    
    @media (max-width: 768px) {
        .cart-summary {
            left: 20px;
            right: 20px;
            min-width: auto;
        }
    }
</style>

<div class="page-header">
    <h1>Th·ª±c ƒê∆°n</h1>
    <p>Kh√°m ph√° c√°c m√≥n ƒÉn ngon c·ªßa ch√∫ng t√¥i</p>
</div>

<div class="category-filter">
    <a href="{% url 'menu' %}" class="category-btn {% if not request.GET.category %}active{% endif %}">T·∫•t C·∫£</a>
    {% for category in categories %}
    <a href="{% url 'menu' %}?category={{ category.id }}" 
       class="category-btn {% if request.GET.category == category.id|stringformat:'s' %}active{% endif %}">
        {{ category.name }}
    </a>
    {% endfor %}
</div>

<div class="menu-grid">
    {% if menu_items %}
        {% for item in menu_items %}
        <div class="menu-item {% if not item.is_available %}unavailable{% endif %}" 
             data-id="{{ item.id }}"
             data-name="{{ item.name }}"
             data-price="{{ item.price }}">
            {% if item.image %}
            <img src="{{ item.image.url }}" alt="{{ item.name }}">
            {% else %}
            <div style="width: 100%; height: 200px; background: var(--nav-bg);"></div>
            {% endif %}
            <div class="menu-item-content">
                <span class="category-tag">{{ item.category.name }}</span>
                <h3>{{ item.name }}</h3>
                <p class="description">{{ item.description }}</p>
                <div class="price">{{ item.price|vnd_format }} <span class="currency">‚Ç´</span></div>
                
                {% if item.is_available %}
                    {% if user.is_authenticated %}
                    <button class="add-btn" onclick="addToCart({{ item.id }}, '{{ item.name }}', {{ item.price }})">
                        <i class="fas fa-plus"></i> Th√™m V√†o Gi·ªè
                    </button>
                    {% else %}
                    <a href="{% url 'login' %}" class="add-btn" style="text-decoration: none;">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng Nh·∫≠p ƒê·ªÉ ƒê·∫∑t
                    </a>
                    {% endif %}
                {% else %}
                <div class="availability unavailable-badge">
                    ‚úó T·∫°m H·∫øt H√†ng
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% else %}
    <div class="no-items" style="grid-column: 1 / -1;">
        <h2>Ch∆∞a c√≥ m√≥n ƒÉn</h2>
        <p>Vui l√≤ng quay l·∫°i sau!</p>
    </div>
    {% endif %}
</div>

{% if user.is_authenticated %}
<!-- Cart Summary -->
<div class="cart-summary" id="cartSummary">
    <h3>üõí Gi·ªè H√†ng C·ªßa B·∫°n</h3>
    <div id="cartItems"></div>
    <div class="cart-total">
        <span>T·ªïng C·ªông:</span>
        <span id="cartTotal">0 ‚Ç´</span>
    </div>
    <div class="cart-actions">
        <button class="cart-btn checkout-btn" onclick="proceedToOrder()">
            <i class="fas fa-shopping-cart"></i> ƒê·∫∑t H√†ng Ngay
        </button>
        <button class="cart-btn clear-btn" onclick="clearCart()">
            <i class="fas fa-trash"></i> X√≥a Gi·ªè H√†ng
        </button>
    </div>
</div>
{% endif %}

<script>
// Cart management
let cart = JSON.parse(localStorage.getItem('restaurantCart')) || [];

// Update cart display
function updateCartDisplay() {
    const cartSummary = document.getElementById('cartSummary');
    const cartItems = document.getElementById('cartItems');
    const cartTotal = document.getElementById('cartTotal');
    
    if (cart.length === 0) {
        cartSummary.classList.remove('show');
        return;
    }
    
    cartSummary.classList.add('show');
    
    // Group items by ID and count quantities
    const groupedCart = cart.reduce((acc, item) => {
        if (acc[item.id]) {
            acc[item.id].quantity++;
        } else {
            acc[item.id] = { ...item, quantity: 1 };
        }
        return acc;
    }, {});
    
    // Display cart items
    cartItems.innerHTML = Object.values(groupedCart).map(item => `
        <div class="cart-item">
            <span>${item.name} x${item.quantity}</span>
            <span>${(item.price * item.quantity).toLocaleString('vi-VN')} ‚Ç´</span>
        </div>
    `).join('');
    
    // Calculate total
    const total = cart.reduce((sum, item) => sum + parseFloat(item.price), 0);
    cartTotal.textContent = total.toLocaleString('vi-VN') + ' ‚Ç´';
    
    // Update button states
    updateButtonStates();
}

// Add item to cart
function addToCart(id, name, price) {
    cart.push({ id, name, price });
    localStorage.setItem('restaurantCart', JSON.stringify(cart));
    updateCartDisplay();
    
    // Visual feedback
    const button = event.target.closest('.add-btn');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> ƒê√£ Th√™m!';
    button.classList.add('added');
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('added');
    }, 1000);
    
    // Show success animation
    showNotification('ƒê√£ th√™m v√†o gi·ªè h√†ng!');
}

// Clear cart
function clearCart() {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô gi·ªè h√†ng?')) {
        cart = [];
        localStorage.setItem('restaurantCart', JSON.stringify(cart));
        updateCartDisplay();
        showNotification('ƒê√£ x√≥a gi·ªè h√†ng');
    }
}

// Proceed to order
function proceedToOrder() {
    if (cart.length === 0) {
        alert('Gi·ªè h√†ng tr·ªëng! Vui l√≤ng th√™m m√≥n ƒÉn.');
        return;
    }
    
    // Store cart in sessionStorage for order page
    sessionStorage.setItem('menuCart', JSON.stringify(cart));
    window.location.href = "{% url 'place_order' %}";
}

// Update button states
function updateButtonStates() {
    const itemsInCart = cart.reduce((acc, item) => {
        acc[item.id] = (acc[item.id] || 0) + 1;
        return acc;
    }, {});
    
    document.querySelectorAll('.menu-item').forEach(item => {
        const id = item.dataset.id;
        const btn = item.querySelector('.add-btn');
        if (btn && itemsInCart[id]) {
            const count = itemsInCart[id];
            // Visual indicator that item is in cart (optional)
        }
    });
}

// Show notification
function showNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 100px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateCartDisplay();
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    @keyframes slideOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(20px);
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}