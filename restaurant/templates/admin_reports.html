{% extends 'base.html' %}
{% load static %}

{% block title %}B√°o C√°o Qu·∫£n Tr·ªã - B√≤ Nh√∫ng Gi·∫•m Ng√†y X∆∞a{% endblock %}

{% block content %}
<style>
    .reports-header {
        background: var(--nav-bg);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .reports-header h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .filter-section {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }
    
    .filter-form {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-color);
    }
    
    .filter-group select,
    .filter-group input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        background: var(--card-bg);
        color: var(--text-color);
    }
    
    .tab-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .tab-button {
        padding: 0.75rem 1.5rem;
        border: 2px solid var(--primary-color);
        background: transparent;
        color: var(--primary-color);
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: var(--transition);
    }
    
    .tab-button.active {
        background: var(--primary-color);
        color: white;
    }
    
    .tab-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px var(--shadow);
    }
    
    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 3rem;
    }
    
    .summary-card {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 6px var(--shadow);
        transition: var(--transition);
    }
    
    .summary-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px var(--shadow);
    }
    
    .summary-icon {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    .summary-label {
        color: var(--text-color);
        opacity: 0.8;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .summary-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .chart-section {
        background: var(--card-bg);
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
    }
    
    .chart-section h2 {
        color: var(--text-color);
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
    }
    
    .chart-container {
        min-height: 300px;
        position: relative;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    
    .data-table th {
        background: var(--primary-color);
        color: white;
        font-weight: 600;
    }
    
    .data-table tr:hover {
        background: var(--border-color);
    }
    
    .data-table td {
        color: var(--text-color);
    }
    
    .export-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .export-btn {
        padding: 0.75rem 1.5rem;
        background: var(--cta-bg);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition);
    }
    
    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px var(--shadow);
    }
    
    .no-data {
        text-align: center;
        padding: 3rem;
        color: var(--text-color);
        opacity: 0.7;
    }
    
    @media print {
        .filter-section,
        .tab-buttons,
        .export-buttons,
        nav,
        footer {
            display: none !important;
        }
        
        body {
            background: white;
        }
        
        .summary-card,
        .chart-section {
            break-inside: avoid;
        }
    }
    
    @media (max-width: 768px) {
        .filter-form {
            flex-direction: column;
        }
        
        .summary-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="reports-header">
    <h1>üìä B√°o C√°o Kinh Doanh</h1>
    <p>Ph√¢n t√≠ch chi ti·∫øt doanh thu v√† ho·∫°t ƒë·ªông nh√† h√†ng</p>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <form method="GET" class="filter-form">
        <div class="filter-group">
            <label for="type">Lo·∫°i B√°o C√°o</label>
            <select name="type" id="type" onchange="this.form.submit()">
                <option value="daily" {% if report_type == 'daily' %}selected{% endif %}>Theo Ng√†y</option>
                <option value="monthly" {% if report_type == 'monthly' %}selected{% endif %}>Theo Th√°ng</option>
                <option value="annual" {% if report_type == 'annual' %}selected{% endif %}>Theo NƒÉm</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="start_date">T·ª´ Ng√†y</label>
            <input type="date" name="start_date" id="start_date" value="{{ start_date|date:'Y-m-d' }}">
        </div>
        
        <div class="filter-group">
            <label for="end_date">ƒê·∫øn Ng√†y</label>
            <input type="date" name="end_date" id="end_date" value="{{ end_date|date:'Y-m-d' }}">
        </div>
        
        <div class="filter-group">
            <button type="submit" class="btn">
                <i class="fas fa-filter"></i> L·ªçc
            </button>
        </div>
    </form>
</div>

<!-- Export Buttons -->
<div class="export-buttons">
    <button onclick="window.print()" class="export-btn">
        <i class="fas fa-print"></i> In B√°o C√°o
    </button>
    <button onclick="exportToCSV()" class="export-btn">
        <i class="fas fa-file-csv"></i> Xu·∫•t CSV
    </button>
</div>

<!-- Summary Cards -->
<div class="summary-grid">
    <div class="summary-card">
        <div class="summary-icon">üõí</div>
        <div class="summary-label">T·ªïng ƒê∆°n H√†ng</div>
        <div class="summary-value">{{ summary.total_orders }}</div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon">üí∞</div>
        <div class="summary-label">T·ªïng Doanh Thu</div>
        <div class="summary-value">{{ summary.total_revenue|floatformat:0 }} ‚Ç´</div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon">üéÅ</div>
        <div class="summary-label">T·ªïng Gi·∫£m Gi√°</div>
        <div class="summary-value">{{ summary.total_discount|floatformat:0 }} ‚Ç´</div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon">üìà</div>
        <div class="summary-label">Gi√° Tr·ªã TB/ƒê∆°n</div>
        <div class="summary-value">{{ summary.average_order_value|floatformat:0 }} ‚Ç´</div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon">‚≠ê</div>
        <div class="summary-label">ƒêi·ªÉm Th∆∞·ªüng T·∫∑ng</div>
        <div class="summary-value">{{ summary.total_points_earned|floatformat:0 }}</div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon">üèÜ</div>
        <div class="summary-label">ƒê∆°n VIP</div>
        <div class="summary-value">{{ summary.vip_orders_count }}</div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon">üí≥</div>
        <div class="summary-label">ƒê∆°n C√≥ Gi·∫£m Gi√°</div>
        <div class="summary-value">{{ summary.discounted_orders_count }}</div>
    </div>
    
    <div class="summary-card">
        <div class="summary-icon">üìä</div>
        <div class="summary-label">T·ª∑ L·ªá D√πng Gi·∫£m Gi√°</div>
        <div class="summary-value">{{ summary.discount_usage_rate|floatformat:1 }}%</div>
    </div>
</div>

<!-- Top Selling Items -->
<div class="chart-section">
    <h2>üçΩÔ∏è Top 10 M√≥n B√°n Ch·∫°y</h2>
    {% if top_items %}
    <table class="data-table">
        <thead>
            <tr>
                <th>H·∫°ng</th>
                <th>T√™n M√≥n</th>
                <th>Danh M·ª•c</th>
                <th>S·ªë L∆∞·ª£ng B√°n</th>
                <th>Doanh Thu</th>
            </tr>
        </thead>
        <tbody>
            {% for item in top_items %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ item.menu_item__name }}</td>
                <td>{{ item.menu_item__category__name }}</td>
                <td>{{ item.quantity_sold }}</td>
                <td>{{ item.revenue|floatformat:0 }} ‚Ç´</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
    {% endif %}
</div>

<!-- Sales by Category -->
<div class="chart-section">
    <h2>üìÇ Doanh Thu Theo Danh M·ª•c</h2>
    {% if category_sales %}
    <div class="chart-container">
        <canvas id="categoryChart"></canvas>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Danh M·ª•c</th>
                <th>S·ªë L∆∞·ª£ng</th>
                <th>Doanh Thu</th>
                <th>% Doanh Thu</th>
            </tr>
        </thead>
        <tbody>
            {% for cat in category_sales %}
            <tr>
                <td>{{ cat.menu_item__category__name }}</td>
                <td>{{ cat.total_quantity }}</td>
                <td>{{ cat.total_revenue|floatformat:0 }} ‚Ç´</td>
                <td>{% widthratio cat.total_revenue summary.total_revenue 100 %}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
    {% endif %}
</div>

<!-- Payment Methods -->
<div class="chart-section">
    <h2>üí≥ Ph∆∞∆°ng Th·ª©c Thanh To√°n</h2>
    {% if payment_methods %}
    <div class="chart-container">
        <canvas id="paymentChart"></canvas>
    </div>
    <table class="data-table">
        <thead>
            <tr>
                <th>Ph∆∞∆°ng Th·ª©c</th>
                <th>S·ªë ƒê∆°n</th>
                <th>Doanh Thu</th>
                <th>% ƒê∆°n H√†ng</th>
            </tr>
        </thead>
        <tbody>
            {% for pm in payment_methods %}
            <tr>
                <td>
                    {% if pm.payment_method == 'bank' %}Chuy·ªÉn Kho·∫£n
                    {% elif pm.payment_method == 'momo' %}MoMo
                    {% elif pm.payment_method == 'cod' %}COD
                    {% else %}{{ pm.payment_method }}{% endif %}
                </td>
                <td>{{ pm.count }}</td>
                <td>{{ pm.revenue|floatformat:0 }} ‚Ç´</td>
                <td>{% widthratio pm.count summary.total_orders 100 %}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
    {% endif %}
</div>

<!-- Discount Breakdown -->
<div class="chart-section">
    <h2>üéÅ Ph√¢n T√≠ch Gi·∫£m Gi√°</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Lo·∫°i Gi·∫£m Gi√°</th>
                <th>S·ªë L·∫ßn S·ª≠ D·ª•ng</th>
                <th>% T·ªïng ƒê∆°n</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Gi·∫£m 5%</td>
                <td>{{ discount_breakdown.5_percent }}</td>
                <td>{% if summary.total_orders > 0 %}{% widthratio discount_breakdown.5_percent summary.total_orders 100 %}%{% else %}0%{% endif %}</td>
            </tr>
            <tr>
                <td>Gi·∫£m 10% (VIP)</td>
                <td>{{ discount_breakdown.10_percent }}</td>
                <td>{% if summary.total_orders > 0 %}{% widthratio discount_breakdown.10_percent summary.total_orders 100 %}%{% else %}0%{% endif %}</td>
            </tr>
            <tr style="font-weight: bold; background: var(--border-color);">
                <td>T·ªïng</td>
                <td>{{ summary.discounted_orders_count }}</td>
                <td>{{ summary.discount_usage_rate|floatformat:1 }}%</td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Top Customers -->
<div class="chart-section">
    <h2>üë• Top 10 Kh√°ch H√†ng</h2>
    {% if top_customers %}
    <table class="data-table">
        <thead>
            <tr>
                <th>H·∫°ng</th>
                <th>T√™n Kh√°ch H√†ng</th>
                <th>S·ªë ƒê∆°n</th>
                <th>T·ªïng Chi Ti√™u</th>
                <th>ƒêi·ªÉm Hi·ªán T·∫°i</th>
            </tr>
        </thead>
        <tbody>
            {% for customer in top_customers %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ customer.customer__username }}</td>
                <td>{{ customer.order_count }}</td>
                <td>{{ customer.total_spent|floatformat:0 }} ‚Ç´</td>
                <td>{{ customer.customer__profile__points|default:0 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
    {% endif %}
</div>

<!-- Time Series Chart -->
<div class="chart-section">
    <h2>üìà Bi·ªÉu ƒê·ªì Doanh Thu Theo Th·ªùi Gian</h2>
    {% if time_data %}
    <div class="chart-container">
        <canvas id="timeSeriesChart"></canvas>
    </div>
    {% else %}
    <div class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu</div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<!-- Chart.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

<script>
    // Parse chart data from Django
    const chartData = {
        timeSeries: {{ chart_data.time_series|safe }},
        categorySales: {{ chart_data.category_sales|safe }},
        paymentMethods: {{ chart_data.payment_methods|safe }},
        statusBreakdown: {{ chart_data.status_breakdown|safe }}
    };
    
    // Chart.js default config
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
    
    // Category Sales Chart
    {% if category_sales %}
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx) {
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: chartData.categorySales.map(c => c.menu_item__category__name),
                datasets: [{
                    data: chartData.categorySales.map(c => c.total_revenue),
                    backgroundColor: [
                        '#D4A843', '#B8860B', '#C19A3B', '#E5C565', 
                        '#8B6914', '#A0792F', '#FFD700'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.label + ': ' + 
                                    context.parsed.toLocaleString('vi-VN') + ' ‚Ç´';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Payment Methods Chart
    {% if payment_methods %}
    const paymentCtx = document.getElementById('paymentChart');
    if (paymentCtx) {
        const paymentLabels = {
            'bank': 'Chuy·ªÉn Kho·∫£n',
            'momo': 'MoMo',
            'cod': 'COD'
        };
        
        new Chart(paymentCtx, {
            type: 'bar',
            data: {
                labels: chartData.paymentMethods.map(p => paymentLabels[p.payment_method] || p.payment_method),
                datasets: [{
                    label: 'S·ªë ƒê∆°n',
                    data: chartData.paymentMethods.map(p => p.count),
                    backgroundColor: '#D4A843'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Time Series Chart
    {% if time_data %}
    const timeCtx = document.getElementById('timeSeriesChart');
    if (timeCtx) {
        let timeLabels, timeValues;
        
        {% if report_type == 'daily' %}
        timeLabels = chartData.timeSeries.map(d => d.hour + ':00');
        timeValues = chartData.timeSeries.map(d => d.revenue);
        {% elif report_type == 'monthly' %}
        timeLabels = chartData.timeSeries.map(d => new Date(d.date).toLocaleDateString('vi-VN'));
        timeValues = chartData.timeSeries.map(d => d.revenue);
        {% else %}
        timeLabels = chartData.timeSeries.map(d => new Date(d.month).toLocaleDateString('vi-VN', {month: 'long', year: 'numeric'}));
        timeValues = chartData.timeSeries.map(d => d.revenue);
        {% endif %}
        
        new Chart(timeCtx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Doanh Thu (‚Ç´)',
                    data: timeValues,
                    borderColor: '#D4A843',
                    backgroundColor: 'rgba(212, 168, 67, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('vi-VN') + ' ‚Ç´';
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'Doanh thu: ' + context.parsed.y.toLocaleString('vi-VN') + ' ‚Ç´';
                            }
                        }
                    }
                }
            }
        });
    }
    {% endif %}
    
    // Export to CSV function
    function exportToCSV() {
        let csv = 'B√°o C√°o Kinh Doanh - B√≤ Nh√∫ng Gi·∫•m Ng√†y X∆∞a\n';
        csv += 'T·ª´ ng√†y: {{ start_date|date:"d/m/Y" }}, ƒê·∫øn ng√†y: {{ end_date|date:"d/m/Y" }}\n\n';
        
        csv += 'T·ªîNG QUAN\n';
        csv += 'T·ªïng ƒë∆°n h√†ng,{{ summary.total_orders }}\n';
        csv += 'T·ªïng doanh thu,{{ summary.total_revenue|floatformat:0 }}\n';
        csv += 'T·ªïng gi·∫£m gi√°,{{ summary.total_discount|floatformat:0 }}\n';
        csv += 'Gi√° tr·ªã TB/ƒê∆°n,{{ summary.average_order_value|floatformat:0 }}\n\n';
        
        csv += 'TOP M√ìN B√ÅN CH·∫†Y\n';
        csv += 'H·∫°ng,T√™n m√≥n,Danh m·ª•c,S·ªë l∆∞·ª£ng,Doanh thu\n';
        {% for item in top_items %}
        csv += '{{ forloop.counter }},{{ item.menu_item__name }},{{ item.menu_item__category__name }},{{ item.quantity_sold }},{{ item.revenue|floatformat:0 }}\n';
        {% endfor %}
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'bao-cao-{{ start_date|date:"Y-m-d" }}.csv';
        link.click();
    }
    
    // Animate cards on load
    window.addEventListener('DOMContentLoaded', function() {
        gsap.from('.summary-card', {
            y: 30,
            opacity: 0,
            duration: 0.6,
            stagger: 0.1,
            ease: 'power2.out'
        });
        
        gsap.from('.chart-section', {
            scrollTrigger: {
                trigger: '.chart-section',
                start: 'top 80%'
            },
            y: 50,
            opacity: 0,
            duration: 0.8,
            stagger: 0.2,
            ease: 'power2.out'
        });
    });
</script>
{% endblock %}