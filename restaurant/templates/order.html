{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}ƒê·∫∑t M√≥n - B√≤ Nh√∫ng Gi·∫•m Ng√†y X∆∞a{% endblock %}

{% block content %}
<style>
    .page-header {
        text-align: center;
        margin-bottom: 3rem;
    }
    
    .page-header h1 {
        font-size: 2.5rem;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }
    
    .rewards-banner {
        background: linear-gradient(135deg, #E5B960 0%, #D4A843 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        text-align: center;
        box-shadow: 0 4px 15px rgba(212, 168, 67, 0.3);
    }
    
    .rewards-banner h3 {
        margin-bottom: 0.5rem;
    }
    
    .order-form {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .category-section {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px var(--shadow);
        border: 1px solid var(--border-color);
    }
    
    .category-section h2 {
        color: var(--primary-color);
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border-color);
    }
    
    .item-row {
        display: grid;
        grid-template-columns: 1fr 100px 150px 100px;
        gap: 1rem;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .item-row.item-header {
        background: var(--border-color);
        font-weight: bold;
        border-bottom: 2px solid var(--primary-color);
        padding: 0.75rem 1rem;
    }
    
    .item-row.item-header .item-info {
        color: var(--text-color);
    }
    
    .item-row:last-child {
        border-bottom: none;
    }
    
    .item-info h4 {
        color: var(--text-color);
        margin-bottom: 0.3rem;
    }
    
    .item-info .description {
        color: var(--text-color);
        opacity: 0.7;
        font-size: 0.9rem;
    }
    
    .item-price {
        font-size: 1.3rem;
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .item-quantity input {
        width: 100%;
        padding: 8px;
        border: 2px solid var(--border-color);
        border-radius: 5px;
        text-align: center;
        background: var(--card-bg);
        color: var(--text-color);
    }
    
    .item-quantity input:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    .item-subtotal {
        font-weight: bold;
        color: var(--text-color);
        text-align: right;
    }
    
    .order-summary {
        background: var(--card-bg);
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 4px 6px var(--shadow);
        border: 1px solid var(--border-color);
        position: sticky;
        top: 100px;
    }
    
    .order-summary h3 {
        color: var(--text-color);
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border-color);
    }
    
    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        color: var(--text-color);
        opacity: 0.9;
    }
    
    .summary-row.total {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--primary-color);
        border-top: 2px solid var(--border-color);
        margin-top: 1rem;
        padding-top: 1rem;
        opacity: 1;
    }
    
    .submit-btn {
        width: 100%;
        margin-top: 1.5rem;
    }
    
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        background: var(--card-bg);
        color: var(--text-color);
    }
    
    .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-color);
    }
    
    @media (max-width: 768px) {
        .item-row {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
        
        .item-subtotal {
            text-align: left;
        }
        
        .order-summary {
            position: static;
        }
    }
</style>

<div class="page-header">
    <h1>üõí ƒê·∫∑t M√≥n</h1>
    <p>Ch·ªçn m√≥n ƒÉn v√† s·ªë l∆∞·ª£ng b√™n d∆∞·ªõi</p>
</div>

{% if profile %}
<div class="rewards-banner">
    <h3>ƒêi·ªÉm Th∆∞·ªüng C·ªßa B·∫°n: {{ profile.points|vnd_format }} ƒêi·ªÉm</h3>
    <p>B·∫°n s·∫Ω nh·∫≠n 10% ƒëi·ªÉm t·ª´ ƒë∆°n h√†ng n√†y!</p>
    <p style="font-size: 0.9rem; margin-top: 0.5rem;">ƒê·ªïi ƒëi·ªÉm th∆∞·ªüng t·∫°i trang L·ªãch S·ª≠ ƒê·∫∑t H√†ng</p>
</div>
{% endif %}

<form method="post" id="orderForm" class="order-form">
    {% csrf_token %}
    
    {% for category in categories %}
    <div class="category-section">
        <h2>{{ category.name }}</h2>
        
        <!-- Column Headers -->
        <div class="item-row item-header">
            <div class="item-info"><strong>M√≥n ƒÇn</strong></div>
            <div style="text-align: center;"><strong>Gi√°</strong></div>
            <div style="text-align: center;"><strong>S·ªë L∆∞·ª£ng</strong></div>
            <div style="text-align: right;"><strong>Th√†nh Ti·ªÅn</strong></div>
        </div>
        
        {% for item in category.items.all %}
            {% if item.is_available %}
            <div class="item-row" data-price="{{ item.price }}" data-id="{{ item.id }}">
                <div class="item-info">
                    <h4>{{ item.name }}</h4>
                    <p class="description">{{ item.description|truncatewords:15 }}</p>
                </div>
                <div class="item-price">{{ item.price|vnd_format }} ‚Ç´</div>
                <div class="item-quantity">
                    <input type="number" 
                           name="quantity_{{ item.id }}" 
                           min="0" 
                           max="20" 
                           value="0" 
                           class="quantity-input"
                           data-item-id="{{ item.id }}">
                </div>
                <div class="item-subtotal" id="subtotal_{{ item.id }}">0 ‚Ç´</div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endfor %}
    
    <div class="category-section">
        <h2>Ghi Ch√∫ ƒê·∫∑c Bi·ªát</h2>
        <div class="form-group">
            <textarea name="special_instructions" 
                      rows="4" 
                      placeholder="Y√™u c·∫ßu ƒë·∫∑c bi·ªát ho·∫∑c h·∫°n ch·∫ø v·ªÅ ch·∫ø ƒë·ªô ƒÉn u·ªëng..."></textarea>
        </div>
    </div>
    
    <div class="order-summary">
        <h3>T√≥m T·∫Øt ƒê∆°n H√†ng</h3>
        <div class="summary-row">
            <span>T·∫°m T√≠nh:</span>
            <span id="subtotal">0 ‚Ç´</span>
        </div>
        <div class="summary-row">
            <span>ƒêi·ªÉm Nh·∫≠n ƒê∆∞·ª£c:</span>
            <span id="points">0 pts</span>
        </div>
        <div class="summary-row total">
            <span>T·ªïng C·ªông:</span>
            <span id="total">0 ‚Ç´</span>
        </div>
        <button type="submit" class="btn submit-btn">Ti·∫øp T·ª•c ‚Üí</button>
    </div>
</form>

<script>
// Format number to VND with dots (thousand separators)
function formatVND(number) {
    // Convert to integer (no decimals)
    number = Math.floor(number);
    // Format with dots as thousand separators
    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function updateTotal() {
    let subtotal = 0;
    const items = document.querySelectorAll('.item-row:not(.item-header)');
    
    items.forEach(item => {
        const price = parseFloat(item.dataset.price);
        const id = item.dataset.id;
        const quantityInput = item.querySelector('.quantity-input');
        
        if (!quantityInput) return; // Skip if no input (like header)
        
        const quantity = parseInt(quantityInput.value) || 0;
        const itemSubtotal = price * quantity;
        
        // Format item subtotal with VND
        const subtotalElement = document.getElementById(`subtotal_${id}`);
        if (subtotalElement) {
            subtotalElement.textContent = `${formatVND(itemSubtotal)} ‚Ç´`;
        }
        subtotal += itemSubtotal;
    });
    
    // Format subtotal
    document.getElementById('subtotal').textContent = `${formatVND(subtotal)} ‚Ç´`;
    
    // No VIP discount on order page - just show subtotal as total
    const total = subtotal;
    
    // Format total
    document.getElementById('total').textContent = `${formatVND(total)} ‚Ç´`;
    
    const points = Math.floor(subtotal * 0.10);
    document.getElementById('points').textContent = `${points} pts`;
}

// Add event listeners to all quantity inputs
document.addEventListener('DOMContentLoaded', function() {
    // Attach change event to all quantity inputs
    const quantityInputs = document.querySelectorAll('.quantity-input');
    quantityInputs.forEach(input => {
        input.addEventListener('input', updateTotal);
        input.addEventListener('change', updateTotal);
    });
    
    // Initialize total
    updateTotal();
    
    // Load cart from menu page if available
    const menuCart = sessionStorage.getItem('menuCart');
    if (menuCart) {
        try {
            const cartItems = JSON.parse(menuCart);
            const itemCounts = cartItems.reduce((acc, item) => {
                acc[item.id] = (acc[item.id] || 0) + 1;
                return acc;
            }, {});
            
            // Set quantities
            Object.entries(itemCounts).forEach(([id, count]) => {
                const input = document.querySelector(`input[name="quantity_${id}"]`);
                if (input) {
                    input.value = count;
                }
            });
            
            // Clear sessionStorage
            sessionStorage.removeItem('menuCart');
            
            // Update totals
            updateTotal();
            
            // Scroll to top
            window.scrollTo(0, 0);
        } catch (e) {
            console.error('Error loading cart:', e);
        }
    }
});

// Form submission - redirect to checkout
document.getElementById('orderForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const quantities = document.querySelectorAll('.quantity-input');
    let hasItems = false;
    let cart = [];
    
    quantities.forEach(input => {
        const quantity = parseInt(input.value) || 0;
        if (quantity > 0) {
            hasItems = true;
            const row = input.closest('.item-row');
            cart.push({
                id: row.dataset.id,
                name: row.querySelector('h4').textContent,
                price: parseFloat(row.dataset.price),
                quantity: quantity
            });
        }
    });
    
    if (!hasItems) {
        alert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt m√≥n v√†o ƒë∆°n h√†ng.');
        return;
    }
    
    // Save cart to sessionStorage for checkout page
    sessionStorage.setItem('checkoutCart', JSON.stringify(cart));
    
    // Also save special instructions if any
    const instructions = document.querySelector('textarea[name="special_instructions"]').value;
    if (instructions) {
        sessionStorage.setItem('specialInstructions', instructions);
    }
    
    // Redirect to checkout
    window.location.href = '{% url "checkout" %}';
});
</script>
{% endblock %}